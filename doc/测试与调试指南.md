# 测试与调试指南

## 1. 验证/测试方法

### 1.1 基本流程

1. **加载扩展**  
   Chrome → 扩展程序 → 加载已解压的扩展程序 → 选择本项目根目录。

2. **在真实提交页验证**  
   - 打开目标站的提交页（如 `https://findly.tools/submit`）。  
   - 点击扩展图标打开 Popup。  
   - 点击「重新识别」：  
     - 若识别成功：会显示「识别成功，找到 N 个可填字段」。  
     - 若未识别到表单：会提示「当前页面未检测到可填表单…」。  
   - 选择站点后点击「一键填充」，检查输入框/下拉是否按预期填充。

3. **为何 findly.tools 可能识别不到**  
   - 页面没有 `<form>`，且可输入控件不在我们扫描的 `input/textarea/select` 里。  
   - 表单是 JS 动态渲染的，在 `document_idle` 时还未出现。  
   - 表单在 iframe 或 Shadow DOM 内（当前脚本未穿透）。  
   - 控件使用非标准标签或自定义组件（如 div+contenteditable）。  

   处理思路：等页面完全加载后再点「重新识别」；若仍不行，需要针对该站做选择器或规则扩展。

---

## 2. 如何提升测试效率与日志查看

Cursor 里不能直接“打开浏览器看报错”，所以依赖**浏览器自带开发者工具**和**固定调试入口**。

### 2.1 三处日志来源（必看）

| 来源 | 如何打开 | 看什么 |
|------|----------|--------|
| **Content Script（页面脚本）** | 在提交页上按 F12 → 切到 **Console** | `[NavSubmitter]` 开头的日志、识别结果、填充时的报错（如 Could not find matching option for: 视频） |
| **Popup** | 扩展图标上**右键** → **检查弹出内容** → 新开一个 DevTools 窗口 | `[Popup]` 开头的日志、`get page state` / `Recognize error`、Invalid URL 等 |
| **Service Worker（Background）** | chrome://extensions → 本扩展卡片上点击「Service Worker」或「背景页」 | 若有 background 逻辑或报错会在这里 |

调试时建议：**先开提交页 F12 Console，再打开 Popup 检查弹出内容**，两边都保留，便于对照。

### 2.2 推荐调试流程

1. **清空缓存再测**  
   - 扩展 Storage：在 Popup 或 options 里若有「清除当前站点映射」可点一次，避免旧缓存导致“识别到 0 个字段”或表现不一致。  
   - 浏览器：必要时对提交页使用无痕或清除该站数据后重试。

2. **复现后立刻看 Console**  
   - 在**提交页** Console 里看是否有 `[NavSubmitter] No form: fields=0, ...`（说明 getFormMetadata 认为没有可填字段）。  
   - 若有 `Could not find matching option for: 视频`，说明分类下拉的选项文案与当前 synonym 不匹配，可据此在 `CATEGORY_SYNONYMS` 里增加该站的选项文案或同义词。

3. **Popup 报错**  
   - `Failed to construct 'URL': Invalid URL`：通常是因为当前 Tab 的 URL 是 `chrome://`、新标签页或扩展页，已通过“仅对 http(s) 解析 URL”做了防护。  
   - `Could not establish connection. Receiving end does not exist`：表示该 Tab 没有注入 Content Script（例如在新标签页、chrome:// 页打开 Popup）。已在 Popup 中给出提示：「无法在此页面使用（请打开普通网页…）」。

4. **本地写一个简单测试页（可选）**  
   - 在 `doc/` 下放一个 `test-form.html`，用标准 `<form>` + `<input name="siteName">` 等，在本地用 `file://` 或本地服务器打开。  
   - 注意：Chrome 对 `file://` 的权限可能限制 content script，若需测 file 协议可临时在 manifest 的 content_scripts.matches 里加上 `file:///*` 做联调。

### 2.3 快速定位“识别为 0 个字段”的思路

- 在 **Content Script** 的 `getFormMetadata()` 里，`formMetadata` 来自当前页的 `form` + 不在 form 里的 `input/textarea/select`。  
- 若控制台看到 `No form: fields=0`：说明要么页面上没有这些元素，要么还没渲染出来。  
- 若 `fields > 0` 但 `mappings.length === 0`：说明 `recognizeByKeywords()` 没有匹配到任何字段（name/label/placeholder 与内置关键词不一致），可考虑为该站加关键词或后续接 LLM 识别。

---

## 3. 已修复的报错与行为（对照用）

- **Unrecognized manifest key 'description__en' / 'name__en'**  
  - 原因：Chrome 不支持这些键。  
  - 处理：已从 `manifest.json` 中移除，仅保留 `name` 与 `description`。

- **Uncaught TypeError: Failed to construct 'URL': Invalid URL**  
  - 原因：在 Popup 中对 `currentTab.url`（如 `chrome://`）直接 `new URL()`。  
  - 处理：仅当 URL 以 `http://` 或 `https://` 开头时才 `new URL()`，否则用字符串或占位符显示。

- **识别成功，找到 undefined 个可填字段**  
  - 原因：缓存结构为 `{ mappings, cachedAt }`，但按数组取 `length`。  
  - 处理：`getCachedMapping()` 统一返回「映射数组」；Popup 用 `result.fieldCount ?? result.mappings?.length` 显示。

- **[NavSubmitter] Could not find matching option for: 视频**  
  - 原因：下拉选项文案与现有 synonym 不完全一致。  
  - 处理：在 `CATEGORY_SYNONYMS` 中为「视频」增加影视、影音、娱乐等同义词，便于匹配更多站点。

- **[Popup] Failed to get page state: Could not establish connection. Receiving end does not exist**  
  - 原因：当前 Tab 未注入 Content Script。  
  - 处理：在 catch 里识别该错误并提示「无法在此页面使用（请打开普通网页…）」。

---

以上为当前推荐的测试方法与日志查看方式；在 Cursor 中无法直接打开浏览器时，以「提交页 Console + Popup 检查弹出内容」为主要调试入口即可。
